<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Message Center - JDM Credit & Finance</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    header {
      background-color: #0a3d62; color: white; padding: 20px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .container { padding: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #0a3d62; color: white; }
    button.whatsapp-btn {
      background-color: #25D366; color: white; border: none;
      padding: 6px 12px; border-radius: 5px; cursor: pointer;
    }
  </style>
</head>
<body>

<header>
  <h2>JDM Credit & Finance - Admin Message Center</h2>
  <button onclick="location.href='admin-dashboard.html'" style="padding:10px 15px; background:crimson; color:white; border:none; border-radius:5px; cursor:pointer;">Back to Dashboard</button>
</header>

<div class="container">
  <h3>All Approved FD & RD Customers</h3>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Customer Name</th>
        <th>Customer ID</th>
        <th>Mobile</th>
        <th>Start Date</th>
        <th>Maturity Date</th>
        <th>WhatsApp</th>
      </tr>
    </thead>
    <tbody id="customerTableBody"></tbody>
  </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDLvrY6y3SyvLrX-yk8UcdO8RmnC89XNG4",
  authDomain: "jdms-207ba.firebaseapp.com",
  projectId: "jdms-207ba",
  storageBucket: "jdms-207ba.appspot.com",
  messagingSenderId: "449814553435",
  appId: "1:449814553435:web:008c7695473689f425307e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function loadCustomersForMessaging() {
  const customerMap = {};

  const customerSnapshot = await db.collection("customers").get();
  customerSnapshot.forEach(doc => {
    customerMap[doc.id] = doc.data();
  });

  const fdSnapshot = await db.collection("fd").where("status", "==", "approved").get();
  const rdSnapshot = await db.collection("rd").where("status", "==", "approved").get();

  const allEntries = [];

  fdSnapshot.forEach(doc => {
    const d = doc.data();
    const c = customerMap[d.customerId];
    if (c && c.mobile) {
      allEntries.push({ type: "FD", name: c.name, customerId: d.customerId, mobile: c.mobile, startDate: d.startDate, maturityDate: d.maturityDate });
    }
  });

  rdSnapshot.forEach(doc => {
    const d = doc.data();
    const c = customerMap[d.customerId];
    if (c && c.mobile) {
      allEntries.push({ type: "RD", name: c.name, customerId: d.customerId, mobile: c.mobile, startDate: d.startDate, maturityDate: d.maturityDate });
    }
  });

  displayForWhatsApp(allEntries);
}

function displayForWhatsApp(entries) {
  const tbody = document.getElementById("customerTableBody");
  tbody.innerHTML = "";
  entries.forEach(e => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${e.type}</td>
      <td>${e.name}</td>
      <td>${e.customerId}</td>
      <td>${e.mobile}</td>
      <td>${e.startDate}</td>
      <td>${e.maturityDate}</td>
      <td><button class="whatsapp-btn" onclick="sendWhatsAppMessage('${e.mobile}', '${e.name}', '${e.maturityDate}')">Send</button></td>
    `;
    tbody.appendChild(row);
  });
}

function sendWhatsAppMessage(mobile, name, maturityDate) {
  const message = `Dear ${name}, your FD/RD is maturing on ${maturityDate}. Please contact Ashutosh Sharma at 9876543210 for renewal assistance. - JDM Credit & Finance`;
  const url = `https://wa.me/91${mobile}?text=${encodeURIComponent(message)}`;
  window.open(url, '_blank');
}

loadCustomersForMessaging();
</script>

</body>
</html>
