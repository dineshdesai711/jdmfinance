<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - JDM Credit & Finance</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #0a3d62;
      color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo-section {
      display: flex;
      align-items: center;
    }
    .logo-section img {
      height: 40px;
      margin-right: 10px;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin: 20px;
      flex-wrap: wrap;
    }
    .stat-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      flex: 1;
      text-align: center;
      min-width: 250px;
    }
    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    table th {
      background-color: #0a3d62;
      color: white;
    }
    .logout-btn {
      background: red;
      color: white;
      border: none;
      padding: 10px 16px;
      cursor: pointer;
      border-radius: 5px;
    }
    h3.section-title {
      margin-left: 20px;
      color: #333;
    }
    .filter-box {
      margin: 0 20px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .filter-box input[type="date"],
    .filter-box button {
      padding: 6px 10px;
      border-radius: 5px;
      border: 1px solid #aaa;
    }
    .action-btn {
      padding: 5px 10px;
      margin: 2px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    .approve-btn { background-color: green; color: white; }
    .reject-btn { background-color: crimson; color: white; }
  </style>
</head>
<body>

  <header>
    <div class="logo-section">
      <img src="https://i.ibb.co/5TpqK1H/banklogo.png" alt="Logo">
      <h2>JDM CREDIT & FINANCE - Admin Panel</h2>
    </div>
    <button onclick="logout()" class="logout-btn">Logout</button>
  </header>

  <div class="stats">
    <div class="stat-box">
      <h3>Total FDs</h3>
      <p id="fdCount">0</p>
    </div>
    <div class="stat-box">
      <h3>Total FD Principal (₹)</h3>
      <p id="totalPrincipal">0</p>
    </div>
    <div class="stat-box">
      <h3>Total RDs</h3>
      <p id="rdCount">0</p>
    </div>
    <div class="stat-box">
      <h3>Total RD Principal (₹)</h3>
      <p id="totalRDPrincipal">0</p>
    </div>
    <div class="stat-box" style="background:#f9c851;">
      <h3>Pending FDs</h3>
      <p id="pendingFDCount">0</p>
    </div>
  </div>

  <div class="filter-box">
    <label><strong>From:</strong> <input type="date" id="fromDate"></label>
    <label><strong>To:</strong> <input type="date" id="toDate"></label>
    <button onclick="applyFilter()">Filter</button>
    <button onclick="loadTodayData()">Reset</button>
  </div>

  <h3 class="section-title">Forgot Password Requests</h3>
  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="forgotTableBody"></tbody>
  </table>

  <h3 class="section-title">Pending FD Entries</h3>
  <table>
    <thead>
      <tr>
        <th>Customer ID</th>
        <th>Name</th>
        <th>Principal</th>
        <th>Start Date</th>
        <th>Maturity</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="pendingFDTableBody"></tbody>
  </table>

  <script>
    function loadForgotRequests() {
      db.collection("forgot_requests").where("status", "==", "pending").onSnapshot(snapshot => {
        const body = document.getElementById("forgotTableBody");
        body.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          body.innerHTML += `
            <tr>
              <td>${data.email || ""}</td>
              <td>${data.date || ""}</td>
              <td>
                <button class="action-btn approve-btn" onclick="approveForgot('${doc.id}', '${data.uid}')">Approve</button>
              </td>
            </tr>`;
        });
      });
    }

    function approveForgot(docId, uid) {
      db.collection("forgot_requests").doc(docId).update({ status: "done" });
      db.collection("custom_passwords").doc(uid).set({ password: "123456" });
      alert("Password set to 123456. Inform the user.");
    }
  </script>

  <script>
    function loadPendingRDs() {
      db.collection("rd").where("status", "==", "pending").onSnapshot(snapshot => {
        const body = document.getElementById("rdTableBody");
        body.innerHTML = "";
        snapshot.forEach(doc => {
          const rd = doc.data();
          body.innerHTML += `
            <tr>
              <td>${rd.customerId || ""}</td>
              <td>${rd.name || ""}</td>
              <td>${rd.aadhaar || ""}</td>
              <td>${rd.pan || ""}</td>
              <td>${rd.startDate || ""}</td>
              <td>${rd.maturityDate || ""}</td>
              <td>${rd.principal || ""}</td>
              <td>${rd.maturityAmount || ""}</td>
              <td>
                <button class="action-btn approve-btn" onclick="updateRDStatus('${doc.id}', 'approved')">Approve</button>
                <button class="action-btn reject-btn" onclick="updateRDStatus('${doc.id}', 'rejected')">Reject</button>
              </td>
            </tr>`;
        });
      });
    }

    function updateRDStatus(docId, status) {
      db.collection("rd").doc(docId).update({ status });
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        const email = user.email.toLowerCase();
        if (!adminEmails.includes(email)) {
          alert("❌ Unauthorized access!");
          auth.signOut().then(() => {
            window.location.href = "index.html";
          });
        } else {
          loadStats();
          loadTodayData();
          loadPendingFDs();
          loadForgotRequests();
          loadPendingRDs();
        }
      } else {
        alert("❌ Not logged in");
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
