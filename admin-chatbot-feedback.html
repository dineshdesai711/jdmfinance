<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üì© Customer Tickets - Admin Panel</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f1f4f9;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      color: #222;
      margin-bottom: 30px;
    }
    .summary {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .summary div {
      background: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-weight: bold;
    }
    .ticket-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    textarea, select, button {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #007bff;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h1>üìã Customer Tickets - Admin Panel</h1>
  <div class="summary" id="summary"></div>
  <div id="ticketContainer">Loading tickets...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, updateDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const ADMIN_EMAILS = [
      "dinesh@gmail.com",
      "desaidinesh055@gmail.com",
      "ashutoshsharma12@gmail.com"
    ];

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const ticketContainer = document.getElementById("ticketContainer");
    const summaryDiv = document.getElementById("summary");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("üîê Please login first.");
        return location.href = "index.html";
      }

      console.log("Logged in as:", user.email);

      if (!ADMIN_EMAILS.includes(user.email)) {
        alert("‚ùå Not authorized admin!");
        return location.href = "index.html";
      }

      // ‚úÖ Load support tickets now
      loadTickets();
    });

    async function loadTickets() {
      const snapshot = await getDocs(collection(db, "support_tickets"));
      ticketContainer.innerHTML = "";

      let total = 0, pending = 0, resolved = 0;

      if (snapshot.empty) {
        ticketContainer.innerHTML = "<p>No support tickets found.</p>";
        return;
      }

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        total++;
        if (data.status === "Resolved") resolved++;
        else pending++;

        const div = document.createElement("div");
        div.className = "ticket-card";
        div.innerHTML = `
          <p><strong>Ticket ID:</strong> ${data.ticketId}</p>
          <p><strong>Name:</strong> ${data.name}</p>
          <p><strong>Email:</strong> ${data.email}</p>
          <p><strong>Subject:</strong> ${data.subject}</p>
          <p><strong>Description:</strong> ${data.description}</p>
          <p><strong>Status:</strong> ${data.status}</p>
          <p><strong>Admin Reply:</strong> ${data.adminReply || 'No reply yet'}</p>
          <textarea id="reply-${docSnap.id}" placeholder="Write your reply...">${data.adminReply || ''}</textarea>
          <select id="status-${docSnap.id}">
            <option ${data.status === "Pending" ? "selected" : ""}>Pending</option>
            <option ${data.status === "Ongoing" ? "selected" : ""}>Ongoing</option>
            <option ${data.status === "Resolved" ? "selected" : ""}>Resolved</option>
          </select>
          <button onclick="replyToTicket('${docSnap.id}')">Reply & Update</button>
        `;
        ticketContainer.appendChild(div);
      });

      summaryDiv.innerHTML = `
        <div>Total: ${total}</div>
        <div>Resolved: ${resolved}</div>
        <div>Pending: ${pending}</div>
      `;
    }

    window.replyToTicket = async (ticketId) => {
      const reply = document.getElementById(`reply-${ticketId}`).value.trim();
      const status = document.getElementById(`status-${ticketId}`).value;

      if (!reply) return alert("Please enter a reply.");

      await updateDoc(doc(db, "support_tickets", ticketId), {
        adminReply: reply,
        status: status,
        updatedAt: new Date().toISOString()
      });

      alert("‚úÖ Ticket updated successfully.");
      location.reload();
    };
  </script>
</body>
</html>
