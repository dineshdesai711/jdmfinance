<!-- ‚úÖ Upgraded admin-message.html with Modern UI, Expandable FD/RD Tables, Select All/Individual Messaging -->
<!-- üì© Now supports WhatsApp redirection, Email logging, and future SMS capability -->
<!-- üìß Email will still use alert, backend integration can replace this -->
<!-- üü¢ WhatsApp redirects from your own number to selected customer with custom message -->

<!-- ‚úÖ HTML starts here -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Messages | JDM Credit and Finance</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f6f8;
      margin: 0;
    }
    header {
      background-color: #003366;
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
    }
    header img {
      height: 40px;
      margin-right: 10px;
    }
    .container {
      padding: 20px;
      max-width: 1100px;
      margin: auto;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    select, button {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .customer-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 10px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .card-header input[type=checkbox] {
      margin-right: 10px;
    }
    .details {
      margin-top: 10px;
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .actions button {
      background-color: #007BFF;
      color: white;
      border: none;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <header>
    <img src="JDM LOGO.png" alt="Logo">
    <h2>JDM CREDIT AND FINANCE - Admin Messages</h2>
  </header>
  <div class="container">
    <div class="toolbar">
      <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"> <label for="selectAll">Select All</label>
      <select id="messageType">
        <option value="">-- Select Message Type --</option>
        <option value="FD_RD_CREATED">‚úÖ FD/RD Created</option>
        <option value="RENEWAL_REMINDER">üîÅ Renewal Reminder</option>
        <option value="FESTIVAL_WISH">üéâ Festival Wish</option>
        <option value="SCHEME_UPDATE">üì¢ New Scheme / Interest Rate</option>
      </select>
      <button onclick="sendBulkMessage()">üöÄ Send</button>
    </div>
    <div id="customer-list">Loading...</div>
  </div>

  <!-- ‚úÖ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = { /* your config as is */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const adminEmails = ["dinesh@gmail.com", "desaidinesh055@gmail.com"];
    const selectedCustomers = new Set();

    window.onload = () => {
      auth.onAuthStateChanged(user => {
        if (!user || !adminEmails.includes(user.email)) return location.href = 'index.html';
        loadCustomers();
      });
    };

    async function loadCustomers() {
      const wrapper = document.getElementById("customer-list");
      wrapper.innerHTML = "";
      const snap = await db.collection("customers").get();
      snap.forEach(async doc => {
        const c = doc.data();
        const fds = await db.collection("fd").where("customerId", "==", c.customerId).get();
        const rds = await db.collection("rd").where("customerId", "==", c.customerId).get();

        const card = document.createElement("div");
        card.className = "customer-card";
        card.innerHTML = `
          <div class="card-header" onclick="toggleDetails('${c.customerId}')">
            <div><input type="checkbox" class="custCheckbox" data-id="${c.customerId}" onclick="event.stopPropagation(); toggleCustomer('${c.customerId}')"> <strong>${c.name}</strong></div>
            <div>${c.mobile} | FD: ${fds.size}, RD: ${rds.size}</div>
          </div>
          <div class="actions">
            <button onclick="event.stopPropagation(); sendWhatsApp('${c.mobile}', '${c.name}')">WhatsApp</button>
            <button onclick="event.stopPropagation(); sendEmail('${c.email}')">Email</button>
          </div>
          <div class="details" id="details-${c.customerId}">
            <table><tr><th colspan="3">FD</th></tr>
            ${fds.docs.map(f => `<tr><td>‚Çπ${f.data().amount}</td><td>${f.data().tenure} mo</td><td>${f.data().maturityDate}</td></tr>`).join('') || '<tr><td colspan="3">No FD</td></tr>'}</table>
            <table><tr><th colspan="3">RD</th></tr>
            ${rds.docs.map(r => `<tr><td>‚Çπ${r.data().amount}</td><td>${r.data().tenure} mo</td><td>${r.data().startDate}</td></tr>`).join('') || '<tr><td colspan="3">No RD</td></tr>'}</table>
          </div>
        `;
        wrapper.appendChild(card);
      });
    }

    function toggleDetails(id) {
      const el = document.getElementById("details-" + id);
      el.style.display = el.style.display === "block" ? "none" : "block";
    }

    function toggleCustomer(id) {
      selectedCustomers.has(id) ? selectedCustomers.delete(id) : selectedCustomers.add(id);
    }

    function toggleSelectAll(cb) {
      document.querySelectorAll('.custCheckbox').forEach(el => {
        el.checked = cb.checked;
        const id = el.dataset.id;
        cb.checked ? selectedCustomers.add(id) : selectedCustomers.delete(id);
      });
    }

    function sendWhatsApp(mobile, name) {
      const type = document.getElementById("messageType").value;
      if (!type) return alert("Select message type first");
      let msg = "Hello " + name + ", ";
      if (type === "FD_RD_CREATED") msg += "your FD/RD has been created successfully.";
      if (type === "RENEWAL_REMINDER") msg += "your FD/RD is due for renewal. Kindly visit soon.";
      if (type === "FESTIVAL_WISH") msg += "we wish you and your family a joyful festival season!";
      if (type === "SCHEME_UPDATE") msg += "please check our new interest rates & schemes.";
      window.open(`https://wa.me/91${mobile}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function sendEmail(email) {
      alert("üìß Simulated email sent to: " + email);
    }

    async function sendBulkMessage() {
      const type = document.getElementById("messageType").value;
      if (!type || selectedCustomers.size === 0) return alert("Please select message type and customers");
      for (const id of selectedCustomers) {
        await db.collection("messages").add({ customerId: id, messageType: type, timestamp: new Date() });
      }
      alert("‚úÖ Messages logged.");
    }
  </script>
</body>
</html>
