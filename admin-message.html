<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Message Center - JDM Credit & Finance</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h2 { color: #0a3d62; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background: #0a3d62; color: white; }
    tr:hover { background: #f1f1f1; cursor: pointer; }
    .message-panel { margin-top: 20px; background: #fff; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 8px; }
    .btn { padding: 10px 15px; margin: 5px; background: #0a3d62; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .btn:disabled { background: #aaa; }
    select, textarea { padding: 10px; width: 100%; margin-top: 10px; }
    .section-title { margin-top: 40px; color: #333; }
  </style>
</head>
<body>

<h2>üì¢ Admin Messaging Center - JDM Credit & Finance</h2>

<table id="customerTable">
  <thead>
    <tr>
      <th><input type="checkbox" onclick="toggleSelectAll(this)"></th>
      <th>Customer ID</th>
      <th>Name</th>
      <th>Mobile</th>
    </tr>
  </thead>
  <tbody id="customerBody"></tbody>
</table>

<h3 class="section-title">Selected Customer's FD/RD Details</h3>
<table>
  <thead>
    <tr>
      <th>Select</th>
      <th>Type</th>
      <th>Principal</th>
      <th>Start Date</th>
      <th>Maturity</th>
    </tr>
  </thead>
  <tbody id="historyBody"></tbody>
</table>

<div class="message-panel">
  <h3>üì® Send Message</h3>
  <label>Select Template:</label>
  <select id="templateSelect" onchange="applyTemplate()">
    <option value="">-- Select Template --</option>
    <option value="thank">Thank You for Opening FD</option>
    <option value="renewal">FD/RD Maturity Reminder</option>
    <option value="festival">Festival Greetings</option>
    <option value="offer">New Interest Rate Offer</option>
  </select>

  <label>Message:</label>
  <textarea id="messageBox" rows="5" placeholder="Your message here..."></textarea>

  <button class="btn" onclick="sendMessage()">üì§ Send WhatsApp</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDLvrY6y3SyvLrX-yk8UcdO8RmnC89XNG4",
    authDomain: "jdms-207ba.firebaseapp.com",
    projectId: "jdms-207ba",
    storageBucket: "jdms-207ba.appspot.com",
    messagingSenderId: "449814553435",
    appId: "1:449814553435:web:008c7695473689f425307e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let selectedCustomers = [];
  let selectedFDs = [];

  async function loadCustomers() {
    const body = document.getElementById("customerBody");
    body.innerHTML = "";
    selectedCustomers = [];

    try {
      const snapshot = await db.collection("customers").get();
      if (snapshot.empty) {
        body.innerHTML = `<tr><td colspan="4">No customers found.</td></tr>`;
        return;
      }

      snapshot.forEach(doc => {
        const d = doc.data();
        const name = d.name || "N/A";
        const mobile = d.mobile || "";
        const customerId = doc.id;

        body.innerHTML += `
          <tr>
            <td><input type='checkbox' value='${customerId}|${name}|${mobile}' onchange='toggleSelect(this)'></td>
            <td>${customerId}</td>
            <td>${name}</td>
            <td>${mobile || 'N/A'}</td>
          </tr>`;
      });
    } catch (error) {
      console.error("‚ùå Error loading customers:", error);
      body.innerHTML = `<tr><td colspan="4">Failed to load customers.</td></tr>`;
    }
  }

  function toggleSelect(checkbox) {
    const val = checkbox.value;
    if (checkbox.checked) {
      if (!selectedCustomers.includes(val)) selectedCustomers.push(val);
    } else {
      selectedCustomers = selectedCustomers.filter(c => c !== val);
    }
  }

  function toggleSelectAll(master) {
    const checkboxes = document.querySelectorAll("#customerBody input[type='checkbox']");
    checkboxes.forEach(cb => {
      cb.checked = master.checked;
      const val = cb.value;
      if (master.checked) {
        if (!selectedCustomers.includes(val)) selectedCustomers.push(val);
      } else {
        selectedCustomers = [];
      }
    });
  }

  async function loadHistory(customerId) {
    const historyBody = document.getElementById("historyBody");
    historyBody.innerHTML = "";
    selectedFDs = [];

    for (const type of ["fd", "rd"]) {
      const snapshot = await db.collection(type).where("customerId", "==", customerId).get();
      snapshot.forEach(doc => {
        const d = doc.data();
        const recordId = `${doc.id}|${type}|${d.customerId}|${d.maturityDate}`;
        historyBody.innerHTML += `
          <tr>
            <td><input type="checkbox" onchange="toggleFDSelect(this)" value="${recordId}"></td>
            <td>${type.toUpperCase()}</td>
            <td>${d.principal}</td>
            <td>${d.startDate}</td>
            <td>${d.maturityDate}</td>
          </tr>`;
      });
    }
  }

  function toggleFDSelect(checkbox) {
    const val = checkbox.value;
    if (checkbox.checked) {
      if (!selectedFDs.includes(val)) selectedFDs.push(val);
    } else {
      selectedFDs = selectedFDs.filter(f => f !== val);
    }
  }

  function applyTemplate() {
    const template = document.getElementById("templateSelect").value;
    const box = document.getElementById("messageBox");
    if (template === "thank") {
      box.value = "Thank you for choosing JDM Credit & Finance. We appreciate your trust in us.";
    } else if (template === "renewal") {
      box.value = "Your FD/RD is maturing soon. Kindly contact Mr. Ashutosh Sharma at 9876543210 for renewal assistance.";
    } else if (template === "festival") {
      box.value = "Wishing you and your family a joyful and prosperous festival. Happy celebrations from JDM Credit & Finance!";
    } else if (template === "offer") {
      box.value = "Check out our new FD/RD interest rates. Now earn more on your savings with JDM Credit & Finance.";
    } else {
      box.value = "";
    }
  }

  function sendMessage() {
    const message = document.getElementById("messageBox").value;
    if (!message.trim()) return alert("Please write a message.");
    if (selectedCustomers.length === 0) return alert("Please select at least one customer.");

    selectedCustomers.forEach(cust => {
      const [id, name, mobile] = cust.split("|");
      if (mobile) {
        const url = `https://wa.me/91${mobile}?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
      } else {
        console.log(`No mobile number found for ${name}`);
      }
    });
  }

  loadCustomers();
</script>

</body>
</html>
