<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Support Dashboard - JDM Credit & Finance</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .summary {
      display: flex;
      justify-content: space-around;
      margin-bottom: 30px;
    }
    .summary div {
      background: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-weight: bold;
    }
    .ticket-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .ticket-card p {
      margin: 8px 0;
    }
    textarea, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h1>ðŸ“‹ Admin Ticket Dashboard</h1>
  <div class="summary" id="summary"></div>
  <div id="ticketContainer">Loading tickets...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      updateDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    // ðŸ” Only allowed 3 admin emails
    const ADMIN_EMAILS = [
      "dinesh@gmail.com",
      "desaidinesh055@gmail.com",
      "ashutoshsharma12@gmail.com"
    ];

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const summaryDiv = document.getElementById("summary");
    const ticketContainer = document.getElementById("ticketContainer");

    onAuthStateChanged(auth, async (user) => {
      if (!user || !ADMIN_EMAILS.includes(user.email)) {
        alert("âŒ Admin not logged in or not authorized");
        return location.href = "index.html";
      }

      const snapshot = await getDocs(collection(db, "support_tickets"));
      let total = 0, resolved = 0, pending = 0;

      ticketContainer.innerHTML = "";

      snapshot.forEach(docSnap => {
        total++;
        const data = docSnap.data();
        if (data.status === "Resolved") resolved++;
        else pending++;

        const div = document.createElement("div");
        div.className = "ticket-card";
        div.innerHTML = `
          <p><strong>Ticket ID:</strong> ${data.ticketId}</p>
          <p><strong>Name:</strong> ${data.name}</p>
          <p><strong>Email:</strong> ${data.email}</p>
          <p><strong>Subject:</strong> ${data.subject}</p>
          <p><strong>Description:</strong> ${data.description}</p>
          <p><strong>Status:</strong> ${data.status}</p>
          <p><strong>Admin Reply:</strong> ${data.adminReply || 'No reply yet'}</p>
          <textarea id="reply-${docSnap.id}" placeholder="Type your reply here...">${data.adminReply || ''}</textarea>
          <select id="status-${docSnap.id}">
            <option ${data.status === 'Pending' ? 'selected' : ''}>Pending</option>
            <option ${data.status === 'Ongoing' ? 'selected' : ''}>Ongoing</option>
            <option ${data.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
          </select>
          <button onclick="replyToTicket('${docSnap.id}')">Reply & Update</button>
        `;
        ticketContainer.appendChild(div);
      });

      summaryDiv.innerHTML = `
        <div>Total: ${total}</div>
        <div>Resolved: ${resolved}</div>
        <div>Pending: ${pending}</div>
      `;
    });

    // âœ… Global reply function
    window.replyToTicket = async (id) => {
      const reply = document.getElementById(`reply-${id}`).value.trim();
      const status = document.getElementById(`status-${id}`).value;

      if (!reply) return alert("Please enter a reply before submitting.");

      await updateDoc(doc(db, "support_tickets", id), {
        adminReply: reply,
        status: status,
        updatedAt: new Date().toISOString()
      });

      alert("âœ… Reply sent and ticket updated successfully.");
      location.reload();
    };
  </script>
</body>
</html>
