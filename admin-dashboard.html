<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - JDM Credit & Finance</title>
  <style>
    body { font-family: Arial; background: #f2f2f2; margin: 0; padding: 0; }
    header {
      background-color: #004080; color: white; padding: 20px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .stats { display: flex; gap: 15px; flex-wrap: wrap; padding: 20px; }
    .stat-box {
      flex: 1; min-width: 200px;
      background: white; border-radius: 8px; padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center;
    }
    table {
      width: 95%; margin: 20px auto; border-collapse: collapse; background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px; border: 1px solid #ccc; text-align: center;
    }
    th { background: #004080; color: white; }
    .approve-btn { background: green; color: white; padding: 5px 10px; border: none; }
    .reject-btn { background: red; color: white; padding: 5px 10px; border: none; }
    .logout-btn {
      background: red; padding: 10px 15px; color: white; border: none; border-radius: 5px;
    }
    .search-box { margin: 0 20px; display: flex; gap: 10px; align-items: center; }
    .reminder-section { background: #fff3cd; padding: 10px; margin: 20px; border-radius: 5px; }
  </style>
</head>
<body>

<header>
  <h2>JDM CREDIT & FINANCE - Admin Panel</h2>
  <button class="logout-btn" onclick="logout()">Logout</button>
</header>

<div class="stats">
  <div class="stat-box"><h3>Total FDs</h3><p id="fdCount">0</p></div>
  <div class="stat-box"><h3>Total FD Principal</h3><p id="fdPrincipal">₹0</p></div>
  <div class="stat-box"><h3>Total RDs</h3><p id="rdCount">0</p></div>
  <div class="stat-box"><h3>Total RD Principal</h3><p id="rdPrincipal">₹0</p></div>
</div>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="Search by name, ID, or mobile">
  <button onclick="searchCustomer()">Search</button>
</div>

<div class="reminder-section">
  <h3>FD/RD Maturing in Next 7 Days:</h3>
  <table id="reminderTable">
    <thead><tr><th>Type</th><th>Customer ID</th><th>Name</th><th>Principal</th><th>Maturity Date</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<h3 style="margin-left:20px;">FD Entries</h3>
<table>
  <thead>
    <tr>
      <th>Customer ID</th><th>Name</th><th>Principal</th><th>Maturity</th><th>Status</th><th>Action</th>
    </tr>
  </thead>
  <tbody id="fdTableBody"></tbody>
</table>

<h3 style="margin-left:20px;">RD Entries</h3>
<table>
  <thead>
    <tr>
      <th>Customer ID</th><th>Name</th><th>Principal</th><th>Maturity</th><th>Status</th><th>Action</th>
    </tr>
  </thead>
  <tbody id="rdTableBody"></tbody>
</table>

<!-- Firebase App SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

<script>
  // ✅ Replace with your Firebase config
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_DOMAIN.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "1234567890",
    appId: "APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function logout() {
    firebase.auth().signOut().then(() => window.location.href = 'login.html');
  }

  function loadDashboardData() {
    db.collection("fd").get().then(snapshot => {
      let fdCount = 0, totalFDPrincipal = 0;
      const tbody = document.getElementById("fdTableBody");
      tbody.innerHTML = "";

      snapshot.forEach(doc => {
        const data = doc.data();
        fdCount++;
        totalFDPrincipal += parseInt(data.principal);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.customerId}</td>
          <td>${data.name}</td>
          <td>₹${data.principal}</td>
          <td>${data.maturityDate}</td>
          <td>${data.status || 'pending'}</td>
          <td>
            <button class="approve-btn" onclick="updateStatus('${doc.id}', 'fd', 'approved')">Approve</button>
            <button class="reject-btn" onclick="updateStatus('${doc.id}', 'fd', 'rejected')">Reject</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("fdCount").innerText = fdCount;
      document.getElementById("fdPrincipal").innerText = `₹${totalFDPrincipal.toLocaleString()}`;
    });

    db.collection("rd").get().then(snapshot => {
      let rdCount = 0, totalRDPrincipal = 0;
      const tbody = document.getElementById("rdTableBody");
      tbody.innerHTML = "";

      snapshot.forEach(doc => {
        const data = doc.data();
        rdCount++;
        totalRDPrincipal += parseInt(data.principal);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.customerId}</td>
          <td>${data.name}</td>
          <td>₹${data.principal}</td>
          <td>${data.maturityDate}</td>
          <td>${data.status || 'pending'}</td>
          <td>
            <button class="approve-btn" onclick="updateStatus('${doc.id}', 'rd', 'approved')">Approve</button>
            <button class="reject-btn" onclick="updateStatus('${doc.id}', 'rd', 'rejected')">Reject</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("rdCount").innerText = rdCount;
      document.getElementById("rdPrincipal").innerText = `₹${totalRDPrincipal.toLocaleString()}`;
    });
  }

  function updateStatus(id, type, status) {
    db.collection(type).doc(id).update({ status }).then(() => loadDashboardData());
  }

  function searchCustomer() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    if (!input) return;

    db.collection("fd").where("name", ">=", input).get().then(snapshot => {
      let total = 0, profit = 0, principal = 0;
      let msg = "";

      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.name.toLowerCase().includes(input) || data.customerId.includes(input) || data.mobile?.includes(input)) {
          principal += parseInt(data.principal);
          profit += parseInt(data.maturityAmount - data.principal);
          total++;
        }
      });

      db.collection("rd").get().then(rdSnap => {
        let rdTotal = 0, rdProfit = 0, rdPrincipal = 0;
        rdSnap.forEach(doc => {
          const data = doc.data();
          if (data.name.toLowerCase().includes(input) || data.customerId.includes(input) || data.mobile?.includes(input)) {
            rdPrincipal += parseInt(data.principal);
            rdProfit += parseInt(data.maturityAmount - data.principal);
            rdTotal++;
          }
        });

        alert(`FD: ${total} | Principal: ₹${principal} | Profit: ₹${profit.toFixed(2)}\nRD: ${rdTotal} | Principal: ₹${rdPrincipal} | Profit: ₹${rdProfit.toFixed(2)}`);
      });
    });
  }

  function loadMaturityReminder() {
    const reminderTbody = document.querySelector("#reminderTable tbody");
    const today = new Date();
    const future = new Date();
    future.setDate(today.getDate() + 7);

    function isWithin7Days(dateStr) {
      const date = new Date(dateStr);
      return date >= today && date <= future;
    }

    reminderTbody.innerHTML = "";

    db.collection("fd").get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        if (isWithin7Days(data.maturityDate)) {
          reminderTbody.innerHTML += `
            <tr><td>FD</td><td>${data.customerId}</td><td>${data.name}</td><td>₹${data.principal}</td><td>${data.maturityDate}</td></tr>
          `;
        }
      });
    });

    db.collection("rd").get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        if (isWithin7Days(data.maturityDate)) {
          reminderTbody.innerHTML += `
            <tr><td>RD</td><td>${data.customerId}</td><td>${data.name}</td><td>₹${data.principal}</td><td>${data.maturityDate}</td></tr>
          `;
        }
      });
    });
  }

  window.onload = () => {
    loadDashboardData();
    loadMaturityReminder();
  };
</script>

</body>
</html>
